<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼ä¸šè®¤è¯ç§‘æ•°æ™ºè§†ç•Œ V10.0 - å…¨å±è‡ªé€‚åº”ç‰ˆ</title>
    <!-- å¼•å…¥èµ„æº -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        /* === å…¨å±€é‡ç½® === */
        * { box-sizing: border-box; outline: none; }
        body {
            margin: 0; padding: 0;
            background-color: #02050b; 
            overflow: hidden; /* ç¦æ­¢æ»šåŠ¨ */
            font-family: "Microsoft YaHei", "Helvetica Neue", sans-serif;
            height: 100vh;
            width: 100vw;
            background-image: 
                radial-gradient(circle at 50% 50%, #111e33 0%, #02050b 100%);
            color: #fff;
            display: flex;
            flex-direction: column;
        }

        /* === å¸ƒå±€å®¹å™¨ === */
        /* é‡‡ç”¨ Flex çºµå‘å¸ƒå±€ï¼šå¤´éƒ¨ -> KPI -> ä¸»å›¾è¡¨ */
        
        /* 1. é¡¶éƒ¨ Header (é«˜åº¦å æ¯” 7% - 8%) */
        .header {
            flex: 0 0 8vh; /* å›ºå®šé«˜åº¦å æ¯” */
            width: 100%;
            background: linear-gradient(to bottom, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.0));
            border-bottom: 1px solid rgba(34, 211, 238, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            position: relative;
            box-shadow: 0 0 20px rgba(34, 211, 238, 0.1);
        }
        /* è£…é¥°çº¿æ¡ */
        .header::after {
            content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, #22d3ee, transparent);
        }

        .header-title {
            font-size: 3.2vh; /* å“åº”å¼å­—ä½“ */
            font-weight: bold;
            letter-spacing: 4px;
            background: linear-gradient(to bottom, #fff, #22d3ee);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(34, 211, 238, 0.5);
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .upload-area { z-index: 10; display: flex; align-items: center; }
        .upload-btn {
            background: rgba(34, 211, 238, 0.1);
            border: 1px solid #22d3ee;
            color: #22d3ee;
            padding: 0.8vh 2vh;
            font-size: 1.8vh;
            cursor: pointer;
            transition: 0.3s;
            border-radius: 4px;
            font-weight: bold;
        }
        .upload-btn:hover { background: #22d3ee; color: #000; box-shadow: 0 0 15px #22d3ee; }

        /* 2. KPI åŒºåŸŸ (é«˜åº¦å æ¯” 12%) */
        .kpi-container {
            flex: 0 0 14vh;
            display: flex;
            justify-content: space-between;
            padding: 1.5vh 1.5vw;
            gap: 1.5vw;
        }
        .kpi-card {
            flex: 1;
            background: rgba(16, 28, 48, 0.4);
            border: 1px solid rgba(64, 169, 255, 0.2);
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.3);
        }
        /* å››è§’é«˜äº®è£…é¥° */
        .card-corner { position: absolute; width: 8px; height: 8px; border: 2px solid #22d3ee; transition: 0.3s; opacity: 0.7; }
        .c-tl { top: -1px; left: -1px; border-right: 0; border-bottom: 0; }
        .c-tr { top: -1px; right: -1px; border-left: 0; border-bottom: 0; }
        .c-bl { bottom: -1px; left: -1px; border-right: 0; border-top: 0; }
        .c-br { bottom: -1px; right: -1px; border-left: 0; border-top: 0; }

        .kpi-val { 
            font-size: 5.5vh; /* å­—ä½“åŠ å¤§ */
            font-weight: 900; color: #fff; 
            text-shadow: 0 0 15px rgba(255,255,255,0.4); 
            font-family: 'Impact', sans-serif; 
            line-height: 1;
        }
        .kpi-label { 
            color: #94a3b8; 
            font-size: 2vh; /* å­—ä½“åŠ å¤§ */
            margin-top: 0.5vh; 
            letter-spacing: 1px; 
        }

        /* 3. ä¸»å›¾è¡¨åŒºåŸŸ (è‡ªé€‚åº”å‰©ä½™é«˜åº¦) */
        .main-grid {
            flex: 1; /* å æ»¡å‰©ä½™ç©ºé—´ */
            display: grid;
            grid-template-columns: 28% 44% 28%; /* å·¦å³æ¯”ä¾‹ */
            gap: 1.5vw;
            padding: 0 1.5vw 2vh 1.5vw;
            min-height: 0; /* é˜²æ­¢å†…å®¹æº¢å‡º */
        }
        
        .col { display: flex; flex-direction: column; gap: 1.5vh; height: 100%; min-height: 0; }
        
        /* å›¾è¡¨å¡ç‰‡ */
        .chart-panel {
            flex: 1;
            background: rgba(13, 22, 39, 0.5);
            border: 1px solid rgba(30, 58, 138, 0.3);
            position: relative;
            padding: 1vh;
            display: flex;
            flex-direction: column;
            min-height: 0; /* å…³é”®ï¼šå…è®¸å­å…ƒç´ ç¼©å° */
        }
        
        .panel-title {
            font-size: 2.2vh; /* å­—ä½“åŠ å¤§ */
            color: #e2e8f0;
            padding-left: 10px;
            border-left: 4px solid #22d3ee;
            margin-bottom: 0.5vh;
            background: linear-gradient(90deg, rgba(34, 211, 238, 0.1), transparent);
            padding: 0.5vh 1vh;
            flex-shrink: 0;
        }

        .chart-div { 
            flex: 1; 
            width: 100%; 
            min-height: 0; /* å¿…é¡»è®¾ç½®ï¼Œå¦åˆ™ ECharts ä¸ä¼šéš Flex ç¼©å° */
        }

        /* é¢œè‰²è¾…åŠ© */
        .text-cyan { color: #22d3ee; text-shadow: 0 0 10px #22d3ee; }
        .text-red { color: #f43f5e; text-shadow: 0 0 10px #f43f5e; }
        #status-msg { margin-right: 15px; color: #4ade80; font-size: 1.6vh; text-shadow: 0 0 5px #4ade80; }

    </style>
</head>
<body>

<!-- 1. å¤´éƒ¨ -->
<div class="header">
    <div style="width: 200px;"></div> <!-- å ä½ -->
    <div class="header-title">ä¼ä¸šè®¤è¯ç§‘æ•°æ™ºè§†ç•Œ V10.0</div>
    <div class="upload-area">
        <span id="status-msg"></span>
        <button class="upload-btn" onclick="document.getElementById('fileInput').click()">ğŸ“‚ ä¸Šä¼  Excel</button>
        <input type="file" id="fileInput" accept=".xlsx, .xls" style="display:none" onchange="handleFile(this)">
    </div>
</div>

<!-- 2. KPI -->
<div class="kpi-container">
    <div class="kpi-card">
        <span class="card-corner c-tl"></span><span class="card-corner c-tr"></span><span class="card-corner c-bl"></span><span class="card-corner c-br"></span>
        <div class="kpi-val text-cyan" id="v_total">-</div>
        <div class="kpi-label">æ€»ä½œä¸šé‡ (Total)</div>
    </div>
    <div class="kpi-card">
        <span class="card-corner c-tl"></span><span class="card-corner c-tr"></span><span class="card-corner c-bl"></span><span class="card-corner c-br"></span>
        <div class="kpi-val" id="v_days">-</div>
        <div class="kpi-label">å¹³å‡è€—æ—¶ (Days)</div>
    </div>
    <div class="kpi-card">
        <span class="card-corner c-tl"></span><span class="card-corner c-tr"></span><span class="card-corner c-bl"></span><span class="card-corner c-br"></span>
        <div class="kpi-val" id="v_rate">-</div>
        <div class="kpi-label">åŠç»“ç‡ (Rate %)</div>
    </div>
    <div class="kpi-card" style="border-color: rgba(244, 63, 94, 0.3);">
        <span class="card-corner c-tl" style="border-color:#f43f5e"></span><span class="card-corner c-tr" style="border-color:#f43f5e"></span>
        <span class="card-corner c-bl" style="border-color:#f43f5e"></span><span class="card-corner c-br" style="border-color:#f43f5e"></span>
        <div class="kpi-val text-red" id="v_err">-</div>
        <div class="kpi-label">å¼‚å¸¸é€€å› (Errors)</div>
    </div>
</div>

<!-- 3. å†…å®¹ç½‘æ ¼ -->
<div class="main-grid">
    <!-- å·¦ä¾§ -->
    <div class="col">
        <div class="chart-panel" style="flex: 4;">
            <div class="panel-title">ä¸šåŠ¡ç±»å‹åˆ†å¸ƒ</div>
            <div id="c1" class="chart-div"></div>
            <span class="card-corner c-bl"></span>
        </div>
        <div class="chart-panel" style="flex: 6;">
            <div class="panel-title">çŠ¶æ€è½¬åŒ–æ¼æ–—</div>
            <div id="c5" class="chart-div"></div>
            <span class="card-corner c-bl"></span>
        </div>
    </div>

    <!-- ä¸­é—´ -->
    <div class="col">
        <div class="chart-panel" style="flex: 6;">
            <div class="panel-title">æœˆåº¦æ¥æ”¶çƒ­åŠ›ç›‘æ§</div>
            <div id="c3" class="chart-div"></div>
            <span class="card-corner c-tr"></span><span class="card-corner c-tl"></span>
        </div>
        <div class="chart-panel" style="flex: 4;">
            <div class="panel-title">è€—æ—¶åŒºé—´åˆ†å¸ƒ</div>
            <div id="c2" class="chart-div"></div>
            <span class="card-corner c-br"></span><span class="card-corner c-bl"></span>
        </div>
    </div>

    <!-- å³ä¾§ -->
    <div class="col">
        <div class="chart-panel" style="height: 100%;">
            <div class="panel-title">å„ç»„æ•ˆèƒ½æ’è¡Œæ¦œ</div>
            <div id="c4" class="chart-div"></div>
            <span class="card-corner c-br"></span><span class="card-corner c-tr"></span>
        </div>
    </div>
</div>

<script>
// === 1. åˆå§‹åŒ–ä¸è‡ªé€‚åº” ===
let charts = {};
// ç§‘æŠ€é£é…è‰²
const techColors = ['#22d3ee', '#3b82f6', '#f43f5e', '#fbbf24', '#a855f7', '#10b981'];
// å­—ä½“åŸºå‡†å¤§å° (ç”¨äºå›¾è¡¨)
const FS_L = 16; // å¤§å·æ ‡ç­¾
const FS_N = 14; // æ™®é€šæ ‡ç­¾
const FS_T = 16; // åæ ‡è½´

window.addEventListener('load', () => {
    charts.c1 = echarts.init(document.getElementById('c1'));
    charts.c2 = echarts.init(document.getElementById('c2'));
    charts.c3 = echarts.init(document.getElementById('c3'));
    charts.c4 = echarts.init(document.getElementById('c4'));
    charts.c5 = echarts.init(document.getElementById('c5'));
    
    showMsg('ç­‰å¾…ä¸Šä¼ æ•°æ®...');
    
    // çª—å£å˜åŒ–æ—¶è‡ªåŠ¨é‡ç»˜ï¼Œå¡«æ»¡å±å¹•
    window.addEventListener('resize', () => {
        Object.values(charts).forEach(c => c.resize());
    });
});

// === 2. æ–‡ä»¶å¤„ç†é€»è¾‘ (ä¿æŒ) ===
function handleFile(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });
            if (json.length === 0) throw new Error("è¡¨æ ¼ä¸ºç©º");
            showMsg(`âœ… å·²åŠ è½½ ${json.length} æ¡æ•°æ®`);
            processData(json);
        } catch (err) {
            alert("âŒ è¯»å–å¤±è´¥ï¼š" + err.message);
        }
    };
    reader.readAsArrayBuffer(file);
}

function showMsg(txt) {
    document.getElementById('status-msg').innerText = txt;
}

// === 3. æ•°æ®å¤„ç† ===
function processData(data) {
    const keys = Object.keys(data[0]);
    const getCol = (names) => keys.find(k => names.some(n => k.trim() === n || k.trim().includes(n)));
    
    const F_START = getCol(['ä½œä¸šæ¥æ”¶æ—¶é—´', 'æ¥æ”¶æ—¶é—´']);
    const F_END = getCol(['è®¤è¯å®Œæˆæ—¶é—´', 'å®Œæˆæ—¶é—´']);
    const F_TEAM = getCol(['è®¤è¯ç»„é•¿', 'ç»„é•¿']);
    const F_TYPE = getCol(['ä½œä¸šç±»å‹']);
    const F_STATUS = getCol(['ä½œä¸šè¿›åº¦', 'è¿›åº¦']);
    const F_RESULT = getCol(['è®¤è¯ç»“æœ']);

    if (!F_START) { alert("âš ï¸ é”™è¯¯ï¼šæœªæ‰¾åˆ°ã€ä½œä¸šæ¥æ”¶æ—¶é—´ã€‘åˆ—"); return; }

    let s = { total: data.length, finished: 0, error: 0, durationSum: 0, durationCount: 0, types: {}, teams: {}, status: {}, heatmap: {}, dist: {'30å¤©å†…':0, '45å¤©å†…':0, '60å¤©å†…':0, '75å¤©å†…':0, '90å¤©å†…':0, '90å¤©ä»¥ä¸Š':0} };

    data.forEach(row => {
        let type = row[F_TYPE] || "å…¶ä»–";
        s.types[type] = (s.types[type] || 0) + 1;

        let progress = row[F_STATUS] ? String(row[F_STATUS]) : "æœªçŸ¥";
        s.status[progress] = (s.status[progress] || 0) + 1;
        if(progress.match(/å®Œæˆ|é€šè¿‡|å·²/)) s.finished++;

        let resultVal = row[F_RESULT] ? String(row[F_RESULT]) : "";
        if (resultVal.match(/é€€|ä¸é€šè¿‡|æ’¤|å¼‚å¸¸|ä¸äºˆ/)) s.error++;

        let team = row[F_TEAM];
        if(team) { if(!s.teams[team]) s.teams[team] = {sum:0, count:0}; }

        let dStart = parseExcelDate(row[F_START]);
        let dEnd = parseExcelDate(row[F_END]);

        if (dStart) {
            let key = dStart.getFullYear() + '-' + (dStart.getMonth()+1);
            s.heatmap[key] = (s.heatmap[key] || 0) + 1;
        }

        if (dStart && dEnd && team) {
            let diff = (dEnd - dStart) / (86400000);
            if (diff >= 0 && diff < 3650) {
                s.durationSum += diff;
                s.durationCount++;
                s.teams[team].sum += diff;
                s.teams[team].count++;
                if(diff<=30) s.dist['30å¤©å†…']++;
                else if(diff<=45) s.dist['45å¤©å†…']++;
                else if(diff<=60) s.dist['60å¤©å†…']++;
                else if(diff<=75) s.dist['75å¤©å†…']++;
                else if(diff<=90) s.dist['90å¤©å†…']++;
                else s.dist['90å¤©ä»¥ä¸Š']++;
            }
        }
    });

    document.getElementById('v_total').innerText = s.total;
    document.getElementById('v_rate').innerText = ((s.finished/s.total)*100).toFixed(1);
    document.getElementById('v_err').innerText = s.error;
    document.getElementById('v_days').innerText = s.durationCount ? (s.durationSum/s.durationCount).toFixed(1) : "-";

    renderCharts(s);
}

// === 4. å›¾è¡¨æ¸²æŸ“ (å­—ä½“è°ƒå¤§) ===
function renderCharts(s) {
    const labelColor = '#cbd5e1';
    const axisConf = { 
        axisLabel: { color: labelColor, fontSize: FS_T }, 
        axisLine: { lineStyle: { color: 'rgba(255,255,255,0.2)' } },
        splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } }
    };

    // C1: é¥¼å›¾
    charts.c1.setOption({
        color: techColors,
        tooltip: { trigger: 'item', textStyle:{fontSize:FS_N} },
        legend: { bottom: '0%', textStyle: { color: '#fff', fontSize: FS_N }, itemWidth: 14, itemHeight: 14 },
        series: [{
            type: 'pie',
            radius: ['45%', '70%'],
            center: ['50%', '45%'],
            itemStyle: { borderRadius: 5, borderColor: '#0f172a', borderWidth: 2 },
            label: { show: true, color: '#fff', fontSize: FS_L, formatter: '{b}\n{d}%' },
            data: Object.keys(s.types).map(k=>({name:k, value:s.types[k]}))
        }]
    });

    // C2: æŸ±çŠ¶å›¾
    let distKeys = ['30å¤©å†…','45å¤©å†…','60å¤©å†…','75å¤©å†…','90å¤©å†…','90å¤©ä»¥ä¸Š'];
    charts.c2.setOption({
        tooltip: { trigger: 'axis', textStyle:{fontSize:FS_N} },
        grid: { top: 30, bottom: 10, left: 10, right: 10, containLabel: true },
        xAxis: { type: 'category', data: distKeys, ...axisConf },
        yAxis: { type: 'value', ...axisConf },
        series: [{
            type: 'bar',
            data: distKeys.map(k=>s.dist[k]),
            barWidth: '40%',
            label: { show: true, position: 'top', color: '#fff', fontSize: FS_N },
            itemStyle: {
                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                    { offset: 0, color: '#22d3ee' },
                    { offset: 1, color: 'rgba(34, 211, 238, 0.1)' }
                ]),
                borderRadius: [4, 4, 0, 0]
            }
        }]
    });

    // C3: çƒ­åŠ›å›¾
    let heatX = ['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
    let heatY = ['2024','2025'];
    let hData = [];
    Object.keys(s.heatmap).forEach(k => {
        let [y, m] = k.split('-');
        if(y === '2024' || y === '2025') {
            hData.push([parseInt(m)-1, y==='2024'?0:1, s.heatmap[k]]);
        }
    });
    
    let maxVal = hData.reduce((m, p) => Math.max(m, p[2]), 1);

    charts.c3.setOption({
        tooltip: { position: 'top', textStyle:{fontSize:FS_N} },
        grid: { bottom: 30, top: 10, left: 60, right: 30 },
        visualMap: {
            min: 0, max: maxVal,
            calculable: true,
            orient: 'horizontal',
            left: 'center', bottom: 0,
            inRange: { color: ['rgba(34, 211, 238, 0.1)', '#22d3ee', '#f43f5e'] },
            textStyle: { color: '#fff', fontSize: FS_N }
        },
        xAxis: { type: 'category', data: heatX, ...axisConf, splitArea: { show: true, areaStyle: { color: ['rgba(255,255,255,0.02)', 'rgba(255,255,255,0.05)'] } } },
        yAxis: { type: 'category', data: heatY, axisLabel: { color: '#fff', fontSize: 18, fontWeight: 'bold' }, splitArea: { show: false }, axisLine:{show:false}, axisTick:{show:false} },
        series: [{
            type: 'heatmap',
            data: hData,
            label: { show: true, color: '#fff', fontSize: 20 },
            itemStyle: { borderColor: '#0f172a', borderWidth: 2 }
        }]
    });

    // C4: æ¡å½¢å›¾
    let teams = Object.keys(s.teams).map(k => ({
        name: k,
        val: s.teams[k].count ? (s.teams[k].sum/s.teams[k].count).toFixed(1) : 0
    })).sort((a,b)=>a.val - b.val);
    
    charts.c4.setOption({
        tooltip: { trigger: 'axis', textStyle:{fontSize:FS_N} },
        grid: { left: 10, right: 60, top: 10, bottom: 0, containLabel: true },
        xAxis: { type: 'value', ...axisConf },
        yAxis: { type: 'category', data: teams.map(t=>t.name), axisLabel: { color: '#fff', fontSize: FS_T }, axisTick: {show:false}, axisLine: {show:false} },
        series: [{
            type: 'bar',
            data: teams.map(t=>t.val),
            barWidth: 20,
            label: { show: true, position: 'right', color: '#fff', fontSize: FS_L, formatter: '{c}å¤©' },
            itemStyle: {
                color: new echarts.graphic.LinearGradient(1, 0, 0, 0, [
                    { offset: 0, color: '#a855f7' },
                    { offset: 1, color: 'rgba(168, 85, 247, 0.1)' }
                ]),
                borderRadius: [0, 4, 4, 0]
            }
        }]
    });

    // C5: æ¼æ–—
    let fData = Object.keys(s.status).map(k=>({name:k, value:s.status[k]})).sort((a,b)=>b.value-a.value);
    charts.c5.setOption({
        color: ['#3b82f6', '#22d3ee', '#10b981', '#fbbf24', '#f43f5e'],
        tooltip: { trigger: 'item', textStyle:{fontSize:FS_N} },
        series: [{
            type: 'funnel',
            left: '5%', right: '5%', top: '5%', bottom: '5%',
            width: '90%',
            sort: 'descending',
            label: { show: true, position: 'inside', color: '#fff', fontSize: FS_L, formatter: '{b}\n{c}' },
            itemStyle: { borderColor: '#fff', borderWidth: 0 },
            data: fData
        }]
    });
}

function parseExcelDate(v) {
    if(!v) return null;
    if(v instanceof Date) return v;
    if(typeof v === 'number') return new Date((v - 25569)*86400000);
    if(typeof v === 'string') {
        let clean = v.replace(/\./g, '/').replace(/-/g, '/');
        let d = new Date(clean);
        return isNaN(d) ? null : d;
    }
    return null;
}
</script>
</body>
</html>
